@page "/transactions/debit"
@using static Common.Utilities.TypeMemberHelpers;
@using OnlineMinion.Web.Transaction.Debit
@using System.Globalization
@using OnlineMinion.Contracts.PaymentSpec.Responses
@using OnlineMinion.Contracts.AccountSpec.Responses
@inherits BaseCRUDPage<
            TransactionDebitListItem,
            OnlineMinion.Contracts.Transactions.Debit.Responses.TransactionDebitResp,
            OnlineMinion.Contracts.Transactions.Debit.BaseUpsertTransactionDebitReqData
            >

@code
{
  protected override RenderFragment RenderEditorComponent() =>
    @<CascadingValue IsFixed="@true" Value="@CT">
      <UpsertEditorWrapper
          Model="@UpsertVM"
          OnCancel="@CloseEditorDialog"
          OnSubmit="@OnUpsertSubmitHandlerAsync"
          @ref="@EditorWrapperRef">
        <EditorFormFields>
          <RadzenFormField Component="@Str.Date" Style="width:30%" Text="@Str.Date" Variant="@Variant.Text">
            <RadzenDatePicker
                Change="@(dateTime => context.Date = DateOnly.FromDateTime(dateTime.GetValueOrDefault()))"
                DateFormat="@CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern"
                TValue="DateTime"
                Value="@(context.Date.ToDateTime(TimeOnly.MinValue))"/>
          </RadzenFormField>
          <RadzenFormField Component="@Str.Amount" Style="width: 30%" Text="@Str.Amount" Variant="@Variant.Text">
            <RadzenNumeric @bind-Value="@context!.Amount" Format="c"/>
          </RadzenFormField>
          <RadzenFormField Component="@Str.Party" Style="width: 36%" Text="@Str.Party" Variant="@Variant.Text">
            <RadzenTextBox @bind-Value="@context!.Party" Trim="@true"/>
          </RadzenFormField>
          <RadzenFormField Component="@Str.Subject" Style="width: 98%" Text="@Str.Subject" Variant="@Variant.Text">
            <RadzenTextBox @bind-Value="@context!.Subject" Trim="@true"/>
          </RadzenFormField>
          <RadzenFormField Style="width: 43%">
            <RadzenDropDown
                AllowClear="@true"
                AllowFiltering="@true"
                @bind-Value="@context.PaymentInstrumentId"
                Data="@PaymentDescriptorViewModels"
                TextProperty="@nameof(PaymentSpecResp.Name)"
                ValueProperty="@nameof(PaymentSpecResp.Id)"/>
          </RadzenFormField>
          <RadzenFormField Style="width: 43%">
            <RadzenDropDown
                AllowClear="@true"
                AllowFiltering="@true"
                @bind-Value="@context.AccountSpecId"
                Data="@AccountDescriptorViewModels"
                TextProperty="@nameof(AccountSpecResp.Name)"
                ValueProperty="@nameof(AccountSpecResp.Id)"/>
          </RadzenFormField>
          <RadzenFormField Component="@Str.Fee" Style="width: 98%" Text="@Str.Fee" Variant="@Variant.Text">
            <RadzenNumeric @bind-Value="@context!.Fee" Format="c"/>
          </RadzenFormField>
          <RadzenFormField Component="@Str.Tags" Style="width:98%" Text="@Str.Tags" Variant="@Variant.Text">
            <RadzenTextBox @bind-Value="@context!.Tags" Trim="@true"/>
          </RadzenFormField>
        </EditorFormFields>
      </UpsertEditorWrapper>
    </CascadingValue>;

  private static class Str
  {
    public const string PageTitle = "Debit trans";
    public const string MainHeading = "Debit Transactions";
    public const string MainDescription = $"Manage {MainHeading}";
    public const string Date = nameof(TransactionDebitListItem.Date);
    public const string Amount = nameof(TransactionDebitListItem.Amount);
    public const string Subject = nameof(TransactionDebitListItem.Subject);
    public const string Party = nameof(TransactionDebitListItem.Party);
    public const string PaymentInstrumentColumn = "paymnt. opt.";
    public const string Tags = nameof(TransactionDebitListItem.Tags);
    public const string Fee = nameof(TransactionDebitListItem.Fee);
    public const string AccountSpecColumn = "acc. spec.";

    public static readonly string PaymentInstrumentName = NestedNameOf<TransactionDebitListItem>(
      x => x.PaymentInstrument.Name
      );

    public static readonly string AccountSpecName = NestedNameOf<TransactionDebitListItem>(
      x => x.AccountSpec.Name
      );
  }

}

<AppPageTitle Text="@Str.PageTitle"/>

<main>
  <RadzenText class="rz-mt-4" Text="@Str.MainHeading" TextStyle="TextStyle.H3"/>
  <RadzenText Text="@Str.MainDescription"/>
  <RadzenDataGridWrapper
      AddClick="@OnAddHandler"
      Data="@ViewModels"
      DeleteClick="@OnDeleteHandlerAsync"
      EditClick="@OnEditHandler"
      LoadData="@OnLoadDataHandlerAsync"
      Page="@PagerChangeHandler"
      PageSizeOptions="@PageSizeOptions"
      @ref="@GridWrapperRef"
      TItem="TransactionDebitListItem"
      TotalItemsCount="@TotalItemsCount">
    <Columns>
      <RadzenDataGridColumn Property="@Str.Date" TItem="TransactionDebitListItem" Title="@Str.Date"/>
      <RadzenDataGridColumn FormatString="{0:C}" Property="@Str.Amount" TItem="TransactionDebitListItem" Title="@Str.Amount"/>
      <RadzenDataGridColumn FormatString="{0:C}" Property="@Str.Fee" TItem="TransactionDebitListItem" Title="@Str.Fee"/>
      <RadzenDataGridColumn Property="@Str.Subject" TItem="TransactionDebitListItem" Title="@Str.Subject"/>
      <RadzenDataGridColumn Property="@Str.Party" TItem="TransactionDebitListItem" Title="@Str.Party"/>
      <RadzenDataGridColumn
          Property="@Str.PaymentInstrumentName"
          TItem="TransactionDebitListItem"
          Title="@Str.PaymentInstrumentColumn"/>
      <RadzenDataGridColumn
          Property="@Str.AccountSpecName"
          TItem="TransactionDebitListItem"
          Title="@Str.AccountSpecColumn"/>
      <RadzenDataGridColumn Property="@Str.Tags" TItem="TransactionDebitListItem" Title="@Str.Tags"/>
    </Columns>
  </RadzenDataGridWrapper>
</main>
